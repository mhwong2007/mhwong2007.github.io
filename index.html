<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://blog.munhou.com').hostname,
    root: '/',
    scheme: 'Mist',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Mun Hou&#39;s Blog">
<meta property="og:url" content="https://blog.munhou.com/index.html">
<meta property="og:site_name" content="Mun Hou&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="MunHou">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://blog.munhou.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>

  <title>Mun Hou's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-61451029-2"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-61451029-2');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Mun Hou's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">Personal Notes</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/mhwong2007" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://blog.munhou.com/2020/03/01/ML-Prediction-with-XGBoost-and-PySpark/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="MunHou">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mun Hou's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/01/ML-Prediction-with-XGBoost-and-PySpark/" class="post-title-link" itemprop="url">ML Prediction with XGBoost and PySpark</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-03-01 13:14:00 / Modified: 14:05:06" itemprop="dateCreated datePublished" datetime="2020-03-01T13:14:00+00:00">2020-03-01</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/03/01/ML-Prediction-with-XGBoost-and-PySpark/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/03/01/ML-Prediction-with-XGBoost-and-PySpark/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Once a XGBoost model is trained, we would like to use PySpark for batch predictions.</p>
<p>The method we use here is through Pandas UDF.</p>
<h2 id="Why-pandas-udf-Instead-of-udf"><a href="#Why-pandas-udf-Instead-of-udf" class="headerlink" title="Why pandas_udf Instead of udf"></a>Why <code>pandas_udf</code> Instead of <code>udf</code></h2><p>For a <code>udf</code> function, PySpark evaluates it one record at a time, which is the slowest possible way to execute the prediction. While for a <code>pandas_udf</code> function, it takes a bunch of pandas <code>Series</code> and returns a <code>Series</code>, which is vectorised.</p>
<h2 id="Create-a-pandas-udf-Prediction-Function"><a href="#Create-a-pandas-udf-Prediction-Function" class="headerlink" title="Create a pandas_udf Prediction Function"></a>Create a <code>pandas_udf</code> Prediction Function</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@pandas_udf(FloatType())</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_prediction_result</span><span class="params">(features)</span>:</span></span><br><span class="line">    <span class="comment"># convert to 2D-numpy array</span></span><br><span class="line">    numpy_array = np.array(</span><br><span class="line">        features</span><br><span class="line">        .values</span><br><span class="line">        .tolist()</span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># convert to xgboost dmatrix</span></span><br><span class="line">    dmatrix = xgb.DMatrix(numpy_array)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># predict</span></span><br><span class="line">    y = model.predict(dmatrix)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># return with pandas series</span></span><br><span class="line">    series = pd.Series(y)</span><br><span class="line">    <span class="keyword">return</span> series</span><br></pre></td></tr></table></figure>

<p>Let’s say we have a dataframe <code>df</code> with following records:</p>
<table>
<thead>
<tr>
<th>features</th>
</tr>
</thead>
<tbody><tr>
<td>[149.0, 84.0. 38.5, 79.7]</td>
</tr>
<tr>
<td>[2.5, 34.0. 35.5, 97.6]</td>
</tr>
<tr>
<td>[0.0, 65.3. 58.7, 45.7]</td>
</tr>
</tbody></table>
<p><code>features</code> is the feature column with <code>ArrayType(FloatType())</code> and each row of <code>features</code> contains 4 feature values.</p>
<p>When we call <code>get_prediction_result</code> function, it receives a <code>Series</code> object. In this case, it would be </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0    [149.0, 84.0, 38.5, 79.7]</span><br><span class="line">1    [2.5, 34.0, 35.5, 97.6]</span><br><span class="line">2    [0.0, 65.3, 58.7, 45.7]</span><br><span class="line">dtype: object</span><br></pre></td></tr></table></figure>

<p>We would need to convert it to a <code>DMatrix</code> object, which is the input for a XGBoost model. We first call its <code>values</code> method, which yields:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">array([list([149.0, 84.0, 38.5, 79.7]), list([2.5, 34.0, 35.5, 97.6]),</span><br><span class="line">       list([0.0, 65.3, 58.7, 45.7])], dtype&#x3D;object)</span><br></pre></td></tr></table></figure>

<p>Then we call <code>tolist</code> to convert it into a list of list, yields:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[149.0, 84.0, 38.5, 79.7], [2.5, 34.0, 35.5, 97.6], [0.0, 65.3, 58.7, 45.7]]</span><br></pre></td></tr></table></figure>

<p>After that, we convert it into a 2D numpy array:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">array([[149. ,  84. ,  38.5,  79.7],</span><br><span class="line">       [  2.5,  34. ,  35.5,  97.6],</span><br><span class="line">       [  0. ,  65.3,  58.7,  45.7]])</span><br></pre></td></tr></table></figure>

<p>Finally, we initialise a <code>DMatrix</code> object with the 2D numpy array we just created. We then run the prediction. As a <code>pandas_udf</code> requires a <code>Series</code> object to return, we convert the prediction scores into a <code>Series</code> at the line 16.</p>
<h2 id="Using-a-pandas-udf-Function"><a href="#Using-a-pandas-udf-Function" class="headerlink" title="Using a pandas_udf Function"></a>Using a <code>pandas_udf</code> Function</h2><p>Using a <code>pandas_udf</code> function is just like how we use a normal <code>udf</code> function:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df.withColumn(<span class="string">'prediction'</span>, get_prediction_result(<span class="string">'features'</span>))</span><br></pre></td></tr></table></figure>


<p>That’s how we integrate the XGBoost batch prediction into our PySpark pipeline.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://blog.munhou.com/2020/01/17/Data-Pipeline-From-Pyspark-to-Pytorch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="MunHou">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mun Hou's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/17/Data-Pipeline-From-Pyspark-to-Pytorch/" class="post-title-link" itemprop="url">Data Pipeline: From PySpark to PyTorch</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-01-17 05:28:00 / Modified: 07:38:29" itemprop="dateCreated datePublished" datetime="2020-01-17T05:28:00+00:00">2020-01-17</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/01/17/Data-Pipeline-From-Pyspark-to-Pytorch/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/01/17/Data-Pipeline-From-Pyspark-to-Pytorch/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h1><p>Uber’s Petastorm library provides a data reader for PyTorch that reads files generated by PySpark. <a href="https://github.com/mhwong2007/petastorm-demo" target="_blank" rel="noopener">Clone the project from Github for more information.</a></p>
<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>As a data scientist, I spend much time wrangling data than making models, and the data scale from hundreds of millions to billions of pieces of records. Spark has been of great use to me due to its capability to process big data. Usually, I run all the dirty jobs with Spark and generated the-ready-to-use-files for the downstream model training process.</p>
<p>However, there is a gap between Spark and PyTorch, which is the data reader. As Spark runs in parallel, it writes multiple partitions of files by default. It’s painful that PyTorch doesn’t provide a data loader with the support of multiple files out of the box. While PyTorch gives a proper level of customisation, writing a high-efficiency data loader is not easy. Then, I found Petastorm.</p>
<p><a href="https://github.com/uber/petastorm" target="_blank" rel="noopener">Petastorm</a> is an open-source data access library developed by Uber that provides more than a data loader. It supports multiple machine learning frameworks, such as TensorFlow, PyTorch, and PySpark. To install Petastorm, run</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install petastorm</span><br></pre></td></tr></table></figure>
<p>Check out their <a href="https://github.com/uber/petastorm" target="_blank" rel="noopener">repository</a> for more details.</p>
<p>In this post, I would like to demonstrate how I process data with PySpark, train a model with PyTorch and fill in the gap in between with Petastorm.</p>
<h1 id="Data-Processing-PySpark"><a href="#Data-Processing-PySpark" class="headerlink" title="Data Processing: PySpark"></a>Data Processing: PySpark</h1><p>We use the famous Iris flower data set as part of the demonstration. We load the CSV file with PySpark and create two new columns: the <code>features</code> column by assembling all the feature vectors and the <code>label</code> column by changing the class string to an integer.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">transform_iris_data</span><span class="params">(data: DataFrame)</span>:</span></span><br><span class="line">    data = (</span><br><span class="line">        data</span><br><span class="line">        .withColumn(<span class="string">'features'</span>,</span><br><span class="line">                    assemble_features(<span class="string">'sepal-length'</span>, <span class="string">'sepal-width'</span>, <span class="string">'petal-length'</span>, <span class="string">'petal-width'</span>)</span><br><span class="line">                    )</span><br><span class="line">        .withColumn(<span class="string">'label'</span>, transform_label(<span class="string">'class'</span>))</span><br><span class="line">        .select(<span class="string">'features'</span>, <span class="string">'label'</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>

<p>After that, we split the data frame into the train set and test set.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">split_train_test</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        data: DataFrame, </span></span></span><br><span class="line"><span class="function"><span class="params">        train_ratio: float = <span class="number">0.7</span>, </span></span></span><br><span class="line"><span class="function"><span class="params">        test_ratio: float = <span class="number">0.3</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> data.randomSplit([train_ratio, test_ratio], seed=<span class="number">42</span>)</span><br></pre></td></tr></table></figure>

<p>Finally, we save the two data frames in parquet format.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(</span><br><span class="line">    train</span><br><span class="line">    .write</span><br><span class="line">    .mode(<span class="string">'overwrite'</span>)</span><br><span class="line">    .parquet(train_path)</span><br><span class="line">)</span><br><span class="line">(</span><br><span class="line">    test</span><br><span class="line">    .write</span><br><span class="line">    .mode(<span class="string">'overwrite'</span>)</span><br><span class="line">    .parquet(test_path)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h1 id="PyTorch-Define-Model"><a href="#PyTorch-Define-Model" class="headerlink" title="PyTorch: Define Model"></a>PyTorch: Define Model</h1><p>We build a simple three-layer network for this easy training task.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_linear_model</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        input_dim: int = <span class="number">4</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        output_dim: int = <span class="number">3</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        device=<span class="string">'cpu'</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span>:</span></span><br><span class="line">    net = nn.Sequential(</span><br><span class="line">        nn.Linear(input_dim, <span class="number">6</span>),</span><br><span class="line">        nn.ReLU(),</span><br><span class="line">        nn.Linear(<span class="number">6</span>, <span class="number">4</span>),</span><br><span class="line">        nn.ReLU(),</span><br><span class="line">        nn.Linear(<span class="number">4</span>, output_dim)</span><br><span class="line">    ).to(device)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> net</span><br></pre></td></tr></table></figure>

<h1 id="Petastorm-The-Data-Reader"><a href="#Petastorm-The-Data-Reader" class="headerlink" title="Petastorm: The Data Reader"></a>Petastorm: The Data Reader</h1><p>Now, it’s time to build the data reader. Building a data reader is simple; what we have to do is to call <code>DataLoader</code> and <code>make_batch_reader</code>, passing in the data path, batch size, and the number of the epoch.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data_loader</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        data_path: str = None,</span></span></span><br><span class="line"><span class="function"><span class="params">        num_epochs: int = <span class="number">1</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        batch_size: int = <span class="number">16</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> data_path:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> DataLoader(</span><br><span class="line">        make_batch_reader(</span><br><span class="line">            dataset_url=data_path,</span><br><span class="line">            num_epochs=num_epochs</span><br><span class="line">        ),</span><br><span class="line">        batch_size=batch_size</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<p>Keep in mind that the <code>dataset_url</code> must consist of the URL scheme. For example, if the data path is <code>/some/localpath/a_dataset</code>, you should pass in <code>file:///some/localpath/a_dataset</code>. Petastorm also supports <code>hdfs://</code> and <code>s3://</code>, but I haven’t tried them yet.</p>
<h1 id="Model-Training"><a href="#Model-Training" class="headerlink" title="Model Training"></a>Model Training</h1><p>The final step is to train our model.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">train_model</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        train_path: str,</span></span></span><br><span class="line"><span class="function"><span class="params">        device: str = <span class="string">'cpu'</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        num_epoch: int = <span class="number">50</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span>:</span></span><br><span class="line">    <span class="comment"># get model</span></span><br><span class="line">    model = get_linear_model()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># define loss function</span></span><br><span class="line">    loss_fun = torch.nn.CrossEntropyLoss()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># define optimiser</span></span><br><span class="line">    opt = torch.optim.Adam(model.parameters(), lr=<span class="number">0.01</span>)</span><br><span class="line"></span><br><span class="line">    model.train()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> range(num_epoch):</span><br><span class="line">        batch_losses = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> batch, data <span class="keyword">in</span> enumerate(get_data_loader(train_path)):</span><br><span class="line">            opt.zero_grad()</span><br><span class="line"></span><br><span class="line">            features = data[<span class="string">'features'</span>].to(device)</span><br><span class="line">            label = data[<span class="string">'label'</span>].to(device)</span><br><span class="line"></span><br><span class="line">            y_pred = model(features)</span><br><span class="line">            loss = loss_fun(y_pred, label)</span><br><span class="line"></span><br><span class="line">            loss.backward()</span><br><span class="line">            opt.step()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># track batch losses</span></span><br><span class="line">            batch_losses += loss.item()</span><br><span class="line"></span><br><span class="line">        avg_batch_loss = batch_losses / (batch + <span class="number">1</span>)</span><br><span class="line">        print(<span class="string">f'Epoch <span class="subst">&#123;epoch&#125;</span> average loss: <span class="subst">&#123;avg_batch_loss&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> model</span><br></pre></td></tr></table></figure>

<p>Using a Petastorm data loader is just like using a PyTorch data loader: wrap it in a for loop.<br>Remember that the data frame previously generated by PySpark consists of only two columns? We can retrieve the values by writing <code>data[&#39;features&#39;]</code> and <code>data[&#39;label&#39;]</code>. If everything goes smoothly, you get a model with the following test performance:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">                 precision    recall  f1-score   support</span><br><span class="line"></span><br><span class="line">    Iris-setosa       1.00      1.00      1.00        11</span><br><span class="line">Iris-versicolor       1.00      1.00      1.00        13</span><br><span class="line"> Iris-virginica       1.00      1.00      1.00        12</span><br><span class="line"></span><br><span class="line">       accuracy                           1.00        36</span><br><span class="line">      macro avg       1.00      1.00      1.00        36</span><br><span class="line">   weighted avg       1.00      1.00      1.00        36</span><br></pre></td></tr></table></figure>

<h1 id="Final-Words"><a href="#Final-Words" class="headerlink" title="Final Words"></a>Final Words</h1><p>Petastorm is a reliable and helpful library. Be sure to check out their latest features!</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://blog.munhou.com/2020/01/16/Summary-of-Malware-Detection-By-Eating-a-Whole-EXE-in-One-Picture/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="MunHou">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mun Hou's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/16/Summary-of-Malware-Detection-By-Eating-a-Whole-EXE-in-One-Picture/" class="post-title-link" itemprop="url">Summary of Malware Detection By Eating a Whole EXE in One Picture</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-01-16 06:50:00 / Modified: 07:23:38" itemprop="dateCreated datePublished" datetime="2020-01-16T06:50:00+00:00">2020-01-16</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/01/16/Summary-of-Malware-Detection-By-Eating-a-Whole-EXE-in-One-Picture/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/01/16/Summary-of-Malware-Detection-By-Eating-a-Whole-EXE-in-One-Picture/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/eating-whole-files/pasted-0.png" alt=""></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">MunHou</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">3</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/mhwong2007" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;mhwong2007" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:mhwong2007@gmail.com" title="E-Mail → mailto:mhwong2007@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/mhwong2007" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;mhwong2007" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/mhwong2007" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;mhwong2007" rel="noopener" target="_blank"><i class="fa fa-fw fa-facebook"></i>FB Page</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">MunHou</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.7.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://munhousblog.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
